#!groovy
/*
 * Copyright 2022 by Swiss Post, Information Technology Services
*
*/

@Library('pipeline-library@master') _

def BUILD_INFO = Artifactory.newBuildInfo()
def PROJECT_NAME = 'evoting-e2e-dev'

pipeline {

	agent {
		label 'proxy-slave'
	}

	parameters {
		string(name: 'COMPONENTS_VERSION', defaultValue: '0.0.0', description: 'Set to the desired version.')
		booleanParam(name: 'PROD', defaultValue: false, description: 'Push on prod')
		booleanParam(name: 'INT', defaultValue: true, description: 'Push on int')
		booleanParam(name: 'ARTIFACTORY', defaultValue: true, description: 'Push on artifactory')
	}

	options {
		disableConcurrentBuilds()
		buildDiscarder(logRotator(numToKeepStr: '10'))
		ansiColor('xterm')
		timestamps()
	}

	environment {
		https_proxy = 'outappl.pnet.ch:3128'
		http_proxy = 'outappl.pnet.ch:3128'
		no_proxy = '.pnet.ch'
		proxyHost = 'outappl.pnet.ch'
		proxyPort = '3128'
	}

	stages {

		stage('Prepare') {
			steps {
				step([$class: 'StashNotifier'])
				echo "Build information : ${BUILD_INFO}"
			}
		}

		stage('Build and push - message-broker on artifactory') {

			when {
				expression { params.ARTIFACTORY == true }
			}

			steps {
				withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 's-cicd-evoting', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS']]) {
					sh "docker login -u ${DOCKER_USER} -p ${DOCKER_PASS} docker.tools.post.ch"

					// MESSAGE-BROKER
					sh "docker build --build-arg DOCKER_REGISTRY=docker.tools.post.ch --no-cache --force-rm -t docker.tools.post.ch/ev/message-broker:${COMPONENTS_VERSION} -f ./message-broker/message-broker.dockerfile ./message-broker/"
					sh "docker push docker.tools.post.ch/ev/message-broker:${COMPONENTS_VERSION}"
				}
			}
		}

		stage('Build and push - message-broker on gitlab int') {

			when {
				expression { params.INT == true }
			}

			steps {
				withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'SwissPost-INTBot', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS']]) {
					sh "docker login -u ${GIT_USER} -p ${GIT_PASS} registry.gitlab.com"

					// MESSAGE-BROKER
					sh "docker build --build-arg DOCKER_REGISTRY=registry.gitlab.com/swisspost-evoting-int/e-voting/evoting-e2e-dev --build-arg http_proxy=outappl.pnet.ch:3128 --build-arg https_proxy=outappl.pnet.ch:3128 --no-cache --force-rm -t registry.gitlab.com/swisspost-evoting-int/e-voting/evoting-e2e-dev/ev/message-broker:${COMPONENTS_VERSION} -f ./message-broker/message-broker.dockerfile ./message-broker/"
					sh "docker push registry.gitlab.com/swisspost-evoting-int/e-voting/evoting-e2e-dev/ev/message-broker:${COMPONENTS_VERSION}"
				}
			}
		}

		stage('Ask password for gitlab prod') {
			steps {
				script {
					if (env.BRANCH_NAME == 'publication-develop' || env.BRANCH_NAME == 'publication-master') {
						def askpass = input(
								message: 'Please enter the password',
								parameters: [
										password(defaultValue: '',
												description: '',
												name: 'password')],
								submitterParameter: 'submitter')
						usernameVariable = askpass.submitter
						passwordVariable = askpass.password
						usernameVariable = 'SwissPost-Bot'
					} else {
						echo "No password required for integration"
					}
				}
			}
		}

		stage('Build and push - message-broker on gitlab prod') {

			when {
				expression { params.PROD == true }
			}

			steps {
				script {
					wrap([$class: 'MaskPasswordsBuildWrapper', varPasswordPairs: [[password: "${passwordVariable}", var: 'passwordVariable']]]) {
						sh "docker login -u ${usernameVariable} -p ${passwordVariable} registry.gitlab.com"

						// MESSAGE-BROKER
						sh "docker pull registry.gitlab.com/swisspost-evoting-int/e-voting/evoting-e2e-dev/ev/message-broker:${COMPONENTS_VERSION}"
						sh "docker tag registry.gitlab.com/swisspost-evoting-int/e-voting/evoting-e2e-dev/ev/message-broker:${COMPONENTS_VERSION} registry.gitlab.com/swisspost-evoting/e-voting/evoting-e2e-dev/ev/message-broker:${COMPONENTS_VERSION}"
						sh "docker push registry.gitlab.com/swisspost-evoting/e-voting/evoting-e2e-dev/ev/message-broker:${COMPONENTS_VERSION}"
					}
				}
			}
		}
	}

	post {
		cleanup {
			step([$class: 'StashNotifier'])
		}
		always {
			step([$class: 'StashNotifier'])
		}
		failure {
			sendBuildMail(projectName: PROJECT_NAME, message: 'Hi, the docker message-broker build and deploy has failed!!', onError: true, toCommitters: true)
		}
	}
}
